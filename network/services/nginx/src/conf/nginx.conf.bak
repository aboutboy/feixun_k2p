user  root;
worker_processes  2;

#error_log  /data/nginx-dns-proxy/huanchuang/logs/error.log notice;
error_log  /usr/nginx/logs/error.log debug;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

pid        /usr/nginx/nginx.pid;


events {
    #use epoll;
    worker_connections   1024;
    #worker_rlimit_nofile 4096;
}

http {
    map_hash_bucket_size 64;
    map $sent_http_content_type $expires {
        default                   3600;
        text/html                 3600;
        text/javascript           3600;
        application/javascript    3600;
        application/x-javascript  3600;
     }

    include       mime.types;
    include       blockips.txt;
    default_type  application/octet-stream;

    log_format  dnsinjectlog '$time_iso8601\t$connection_requests\t$remote_addr\t$cache_status'
                     '\t$inject_js_status\t$sent_http_content_type\t$bytes_sent(B)\t$request_method\tHTTP-$status\t$scheme://$http_host$request_uri\t$http_referer\t$http_user_agent';
    #access_log   /data/nginx-dns-proxy/huanchuang/logs/inject.log dnsinjectlog;
    access_log   /usr/nginx/logs/inject.log dnsinjectlog;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  10;


   proxy_ignore_client_abort on;
   #proxy_http_version  1.1;
   proxy_cache_path  /usr/nginx/cache levels=1:2 keys_zone=cache_zone:1m inactive=1h use_temp_path=on;

   map $request_method $purge_method {
        PURGE   1;
        default 0;
   }

   map $host $allow {
       	default 1;
   }

server{
    resolver 180.76.76.76;
    resolver_timeout 2s;

    listen 192.168.0.1:80;
   
    location / {
        root html;
        index index.html index.htm;
        proxy_pass $scheme://$host$request_uri;
        proxy_set_header HOST $http_host;
        proxy_buffers 256 4k;
        proxy_max_temp_file_size 0k;
        proxy_connect_timeout 30; 
        proxy_send_timeout 60;
        proxy_read_timeout 60;
        proxy_next_upstream error timeout invalid_header http_502;

        proxy_redirect off;

        proxy_cache cache_zone;

        proxy_cache_valid 200 302 1m;
        proxy_cache_valid 301 1m;
        proxy_cache_valid any 1m;

        proxy_ignore_headers  Cache-control;
        proxy_hide_header     Cache-control;
        proxy_ignore_headers  Expires;
        proxy_hide_header     Expires;

        proxy_hide_header     X-XSS-Protection;
        proxy_hide_header     X-WebKit-CSP;
        proxy_hide_header     X-Content-Type-Options;
        proxy_hide_header     X-Content-Security-Policy;
        proxy_hide_header     Content-Security-Policy;

        proxy_cache_type_valid $expires;
        expires $expires;

        #gunzip on;
        #gunzip_buffers 16 8k;

        gzip on;
        #gzip_proxied any;
        gzip_min_length 1k;
        gzip_buffers 4 16k;
        gzip_http_version 1.0;
        gzip_comp_level 2;
        gzip_types text/plain application/x-javascript  text/javascript application/javascript application/css  text/css application/xml text/  javascript application/x-httpd-php image/jpeg image/gif image/png;
        gzip_vary off;
        gzip_disable "MSIE [1-6]\.";

        #sub_filter_once  on;
        #sub_filter_file  'text/html'     '</body>'     /usr/local/nginx/conf/ij.html;
        #sub_tail_file    'application/javascript'      /usr/local/nginx/conf/ij.js;
        #sub_tail_file    'application/x-javascript'    /usr/local/nginx/conf/ij.js;
        #sub_tail_file    'text/javascript'             /usr/local/nginx/conf/ij.js;

        if ($allow ~ ^0){
            return 403;
        }
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
         root html;
    }
}
}
